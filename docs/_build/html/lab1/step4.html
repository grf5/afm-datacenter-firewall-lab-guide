<!DOCTYPE html>
<head>
  
  <!--STAGING:-->
  <script src="https://assets.adobedtm.com/50164577268f481934e5d57dbfb78f929164cd0d/satelliteLib-ea775cfabef5fca8b04e9392f20c986c0724a7c3-staging.js"></script>
  <!--Production:-->
  <script src="https://assets.adobedtm.com/50164577268f481934e5d57dbfb78f929164cd0d/satelliteLib-ea775cfabef5fca8b04e9392f20c986c0724a7c3.js"></script>
    <title>4.5. Creating AFM Network Firewall Rules</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="kb_doc_type" content="Manual"/>
  <meta name="kb_doc_type" content="User Guide"/>
  <meta name="title" content="4.5. Creating AFM Network Firewall Rules"/>
  <meta name="product" content="F5 BIG-IP AFM - The Data Center Firewall Lab"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="None"/>
  <meta name="archived" content="Archived documents excluded"/>

  
  
  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">
 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script type="text"> jQuery.noConflict(true)</script>

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4.5. Creating AFM Network Firewall Rules &#8212; F5 BIG-IP AFM - The Data Center Firewall Lab  documentation</title>
    <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/f5_agility_theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/f5.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/f5-theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/21fb8a09c3.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.6. AFM Reference Material" href="step5.html" />
    <link rel="prev" title="4.4. Advanced Firewall Manager (AFM)" href="step3.html" />
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="dismiss">
      <button type="button" class="btn btn-info navbar-btn site-hidden"><i class="fa fa-align-justify"></i></button>
    </div>
    <div id="sidebar" class="section-nav">
      <nav class="nav-sidebartoc">
        <h5>F5 BIG-IP AFM - The Data Center Firewall Lab  documentation </h5>
<div id="searchbox" role="search">
  <form class="search" action="../search.html" method="get">
    <input type="text" class="search" name="q" placeholder=" Search..." />
    <button type="submit" class="btn btn-info navbar-btn"><i class="fa fa-search"></i></button>
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        <hr>
        <h5>Current Page</h5>
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">4.5. Creating AFM Network Firewall Rules</a><ul>
<li><a class="reference internal" href="#default-actions">4.5.1. Default Actions</a></li>
<li><a class="reference internal" href="#rule-hierarchy">4.5.2. Rule Hierarchy</a></li>
<li><a class="reference internal" href="#create-and-view-log-entries">4.5.3. Create and View Log Entries</a></li>
<li><a class="reference internal" href="#create-a-rule-list">4.5.4. Create a Rule List</a></li>
<li><a class="reference internal" href="#create-a-policy-with-a-rule-list">4.5.5. Create a Policy with a Rule List</a></li>
<li><a class="reference internal" href="#add-the-rule-list-to-a-route-domain">4.5.6. Add the Rule List to a Route Domain</a></li>
<li><a class="reference internal" href="#test-the-new-firewall-rules">4.5.7. Test the New Firewall Rules</a></li>
<li><a class="reference internal" href="#creating-an-additional-rule-list-for-additional-services">4.5.8. Creating an Additional Rule List for Additional Services</a></li>
<li><a class="reference internal" href="#add-another-rule-list-to-the-policy">4.5.9. Add Another Rule List to the Policy</a></li>
<li><a class="reference internal" href="#test-access-to-the-server">4.5.10. Test Access to the Server</a></li>
<li><a class="reference internal" href="#test-access-to-the-server-1">4.5.11. Test Access to the Server</a></li>
<li><a class="reference internal" href="#id2">4.5.12. Test the New Firewall Rules</a></li>
<li><a class="reference internal" href="#view-firewall-reports">4.5.13. View Firewall Reports</a></li>
</ul>
</li>
</ul>

         </span>
        <hr>
        <h5>Site Contents</h5>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro1.html">1. Advanced Firewall Manager - The Data Center Firewall</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro2.html">2. Connecting to the Training Lab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro3.html">3. Ravello Environment Pre-Check</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="intro.html">4. Lab 1 – Advanced Firewall Manager (AFM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab2/intro.html">5. Lab 2 - AFM Packet Tester, Flow Inspector, Stale Rule Lab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab3/intro.html">6. Lab 3 - AFM DDoS Lab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab4/intro.html">7. Lab 4 - Device Management Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab5/intro.html">8. Lab 5 - Network Security (AFM) Management Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab6/intro.html">9. Lab 6 - iControl REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conclusion.html">10. Conclusion</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>

  
  <div class="main active" id="content">
    <article class="docs-container site-article-inner">
            <nav class="site-breadcrumb-nav site-nav">
          <ul class="site-breadcrumb-list">
            <li class="breadcrumb-item"><button type="button" id="sidebarCollapse" class="btn btn-info navbar-btn site-hidden"><i class="fa fa-align-justify"></i></button>&#x20 <a href="/">Community Training Classes &amp; Labs</a> &gt; <a href="../index.html">F5 BIG-IP AFM - The Data Center Firewall Lab </a> &gt; 4.5. Creating AFM Network Firewall Rules</li>
          </ul>
      </nav>
      
      

    
  <div class="section" id="creating-afm-network-firewall-rules">
<h1>4.5. Creating AFM Network Firewall Rules<a class="headerlink" href="#creating-afm-network-firewall-rules" title="Permalink to this headline">¶</a></h1>
<div class="section" id="default-actions">
<h2>4.5.1. Default Actions<a class="headerlink" href="#default-actions" title="Permalink to this headline">¶</a></h2>
<p>The BIG-IP<sup>®</sup> Network Firewall provides policy-based access
control to and from address and port pairs, inside and outside of your
network. Using a combination of contexts, the network firewall can apply
rules in many ways, including: at a global level, on a per-virtual
server level, and even for the management port or a self IP address.
Firewall rules can be combined in a firewall policy, which can contain
multiple context and address pairs, and is applied directly to a virtual
server.</p>
<p>By default, the Network Firewall is configured in <strong>ADC mode</strong>, a
default allow configuration, in which all traffic is allowed through the
firewall, and any traffic you want to block must be explicitly
specified.</p>
<p>The system is configured in this mode by default so all traffic on your
system continues to pass after you provision the Advanced Firewall
Manager. You should create appropriate firewall rules to allow necessary
traffic to pass before you switch the Advanced Firewall Manager to
Firewall mode. In <strong>Firewall mode</strong>, a default deny configuration, all
traffic is blocked through the firewall, and any traffic you want to
allow through the firewall must be explicitly specified.</p>
<p>The BIG-IP<sup>®</sup> Network Firewall provides policy-based access
control to and from address and port pairs, inside and outside of your
network. By default, the network firewall is configured in ADC mode,
which is a <strong>default allow</strong> configuration, in which all traffic is
allowed to virtual servers and self IPs on the system, and any traffic
you want to block must be explicitly specified. This applies only to the
Virtual Server &amp; Self IP level on the system.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Even though the system is in a default allow configuration, if a packet matches no rule in any context on the firewall, a Global Drop rule drops the traffic.</p>
</div>
</div>
<div class="section" id="rule-hierarchy">
<h2>4.5.2. Rule Hierarchy<a class="headerlink" href="#rule-hierarchy" title="Permalink to this headline">¶</a></h2>
<p>With the BIG-IP<sup>®</sup> Network Firewall, you use a context to
configure the level of specificity of a firewall rule or policy. For
example, you might make a global context rule to block ICMP ping
messages, and you might make a virtual server context rule to allow only
a specific network to access an application.</p>
<p>Context is processed in this order:</p>
<ul class="simple">
<li>Global</li>
<li>Route domain</li>
<li>Virtual server / self IP</li>
<li>Management port*</li>
<li>Global drop*</li>
</ul>
<p>The firewall processes policies and rules in order, progressing from the
global context, to the route domain context, and then to either the
virtual server or self IP context. Management port rules are processed
separately, and are not processed after previous rules. Rules can be
viewed in one list, and viewed and reorganized separately within each
context. You can enforce a firewall policy on any context except the
management port. You can also stage a firewall policy in any context
except management.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You cannot configure or change the Global Drop context. The Global Drop context is the final context for traffic. Note that even though it is a global context, it is not processed first, like the main global context, but last. If a packet matches no rule in any previous context, the Global Drop rule drops the traffic.</p>
</div>
<img alt="http://support.f5.com/kb/global/manual_images/MAN-0439-01/firewall_processing.png" src="http://support.f5.com/kb/global/manual_images/MAN-0439-01/firewall_processing.png" />
</div>
<div class="section" id="create-and-view-log-entries">
<h2>4.5.3. Create and View Log Entries<a class="headerlink" href="#create-and-view-log-entries" title="Permalink to this headline">¶</a></h2>
<p>In this section, you will generate various types of traffic through the
firewall as you did previously, but now you will view the log entries
using the network firewall log. Open your web browser and once again try
to access <a class="reference external" href="http://10.30.0.50">http://10.30.0.50</a>. Also, try to ping 10.30.0.50.</p>
<p>Open the <strong>Security &gt; Event Logs &gt; Network &gt; Firewall</strong> page on
bigip2.dnstest.lab (192.168.1.150). The log file shows the ping requests
are being accepted and the web traffic is being dropped:</p>
<p><a class="reference internal" href="../_images/image7.png"><img alt="image6" src="../_images/image7.png" style="width: 6.49097in; height: 1in;" /></a></p>
<p>Although we will not configure external logging in this lab, you should
be aware that the BIG-IP supports high speed external logging in various
formats including <strong>SevOne</strong>, <strong>Splunk</strong> and <strong>ArcSight</strong>.</p>
</div>
<div class="section" id="create-a-rule-list">
<h2>4.5.4. Create a Rule List<a class="headerlink" href="#create-a-rule-list" title="Permalink to this headline">¶</a></h2>
<p>Rule lists are a way to group a set of individual rules together and
apply them to the active rule base as a group. A typical use of a rule
list would be for a set of applications that have common requirements
for access protocols and ports. As an example, most web applications
would require TCP port 80 for HTTP and TCP port 443 for SSL/TLS. You
could create a Rule list with these protocols, and apply them to each of
your virtual servers.</p>
<p>Let’s examine some of the default rule lists that are included with AFM.</p>
<p>Go to <strong>Security &gt;Network Firewall &gt; Rule Lists</strong>. They are:</p>
<ul class="simple">
<li>_sys_self_allow_all</li>
<li>_sys_self_allow_defaults</li>
<li>_sys_self_allow_management</li>
</ul>
<p><a class="reference internal" href="../_images/image8.png"><img alt="image7" src="../_images/image8.png" style="width: 6.5in; height: 1.46319in;" /></a></p>
<p>If you click on <strong>_sys_self_allow_management</strong> you’ll see that it is
made up of two different rules that will allow management traffic (port
22/SSH and port 443 HTTPS). Instead of applying multiple rules over and
over across multiple servers, you can put them in a rule list and then
apply the rule list as an ACL.</p>
<p><a class="reference internal" href="../_images/image9.png"><img alt="image8" src="../_images/image9.png" style="width: 6.5in; height: 0.80278in;" /></a></p>
<p>On bigip2.dnstest.lab (192.168.1.150) create a rule list to allow Web
traffic. A logical container must be created before the individual rules
can be added. You will create a list with two rules, to allow port 80
(HTTP) and reject traffic from a specific IP subnet. First you need to
create a container for the rules by going to:</p>
<p><strong>Security &gt; Network Firewall &gt; Rule Lists</strong> and select <strong>Create.</strong></p>
<p>For the <strong>Name</strong> enter <strong>web_rule_list</strong>, provide an optional
description and then click <strong>Finished.</strong></p>
<p><a class="reference internal" href="../_images/image10.png"><img alt="image9" src="../_images/image10.png" style="width: 3.25in; height: 1.46554in;" /></a></p>
<p>Edit the <strong>web_rule_list</strong> by selecting it in the Rule Lists table, then
click the <strong>Add</strong> button in the Rules section. Here you will add two
rules into the list; the first is a rule to allow HTTP.</p>
<p><a class="reference internal" href="../_images/image11.png"><img alt="image10" src="../_images/image11.png" style="width: 6.2954in; height: 1.66667in;" /></a></p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Name</strong></th>
<th class="head">allow_http</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>Protocol</strong></td>
<td>TCP</td>
</tr>
<tr class="row-odd"><td><strong>Source</strong></td>
<td>Leave at Default of <strong>Any</strong></td>
</tr>
<tr class="row-even"><td><strong>Destination Address</strong></td>
<td><strong>Specify…</strong>10.30.0.50, then click <strong>Add</strong></td>
</tr>
<tr class="row-odd"><td><strong>Destination Port</strong></td>
<td><strong>Specify…</strong> Port <strong>80</strong>, then click <strong>Add</strong></td>
</tr>
<tr class="row-even"><td><strong>Action</strong></td>
<td><strong>Accept-Decisively</strong></td>
</tr>
<tr class="row-odd"><td><strong>Logging</strong></td>
<td>Enabled</td>
</tr>
</tbody>
</table>
<p><a class="reference internal" href="../_images/image12.png"><img alt="image11" src="../_images/image12.png" style="width: 5.87014in; height: 6.17122in;" /></a></p>
<p>Select <strong>Repeat</strong> when done.</p>
<p>Create another rule to reject all access from the 10.20.0.0/24 network.</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Name</strong></th>
<th class="head">reject_10_20_0_0</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>Protocol</strong></td>
<td>Any</td>
</tr>
<tr class="row-odd"><td><strong>Source</strong></td>
<td><strong>Specify…</strong>Address 10.20.0.0/24,
then click <strong>Add</strong></td>
</tr>
<tr class="row-even"><td><strong>Destination Address</strong></td>
<td>Any</td>
</tr>
<tr class="row-odd"><td><strong>Destination Port</strong></td>
<td>Any</td>
</tr>
<tr class="row-even"><td><strong>Action</strong></td>
<td>Reject</td>
</tr>
<tr class="row-odd"><td><strong>Logging</strong></td>
<td>Enabled</td>
</tr>
</tbody>
</table>
<p>Select <strong>Finished</strong> when completed. When you exit, you’ll notice the
reject rule is after the <strong>allow_http</strong> rule. This means that HTTP
traffic from 10.20.0.0/24 will be accepted, while all other traffic from
this subnet will be rejected based on the ordering of the rules as seen
below:</p>
<p><a class="reference internal" href="../_images/image13.png"><img alt="image12" src="../_images/image13.png" style="width: 6.49097in; height: 0.25903in;" /></a></p>
</div>
<div class="section" id="create-a-policy-with-a-rule-list">
<h2>4.5.5. Create a Policy with a Rule List<a class="headerlink" href="#create-a-policy-with-a-rule-list" title="Permalink to this headline">¶</a></h2>
<p>Policies are a way to group a set of individual rules together and apply
them to the active policy base as a group. A typical use of a policy
list would be for a set of rule lists that have common requirements for
access protocols and ports.</p>
<p>Create a policy list to allow the traffic you created in the rule list
in the previous section. A logical container must be created before the
individual rules can be added. First you need to create a container for
the policy by going to:</p>
<p><strong>Security &gt; Network Firewall &gt; Policies</strong> and select <strong>Create.</strong></p>
<p>You’ll notice that before Milton detached from Initech, he created a
global policy named <strong>‘Global’</strong> to allow basic connectivity to make
troubleshooting easier.</p>
<p>For the <strong>Name</strong> enter <strong>rd_0_policy</strong>, provide an optional description
and then click <strong>Finished.
(Note: We commonly use “RD” in our rules to help reference the “Route
Domain”, default is 0)</strong></p>
<p><a class="reference internal" href="../_images/image14.png"><img alt="image13" src="../_images/image14.png" style="width: 4.92847in; height: 1.35694in;" /></a></p>
<p>Edit the <strong>rd_0_policy</strong> by selecting it in the Policy Lists table, then
click the <strong>Add Rule List</strong> button. Here you will add the rule list you
created in the previous section. For the <strong>Name,</strong> start typing
<strong>web_rule_list</strong>, you will notice the name will auto complete, select
the rule list <strong>/Common/web_rule_list</strong>, provide an optional description
and then click <strong>Done Editing.</strong></p>
<p><a class="reference internal" href="../_images/image15.png"><img alt="image14" src="../_images/image15.png" style="width: 6.5in; height: 0.60208in;" /></a></p>
<p>When finished your policy should look like the screen shot below.</p>
<p><a class="reference internal" href="../_images/image16.png"><img alt="image15" src="../_images/image16.png" style="width: 6.5in; height: 1.29653in;" /></a></p>
<p>You will notice the changes are unsaved and need to be committed to the
system. This is a nice feature to have enabled to verify you want to
commit the changes you’ve just made without a change automatically being
implemented.</p>
<p>To commit the change, simply click <strong>“Commit</strong> Changes <strong>to System”</strong>
located at the top of the screen.</p>
<p><a class="reference internal" href="../_images/image17.png"><img alt="image16" src="../_images/image17.png" style="width: 6.49097in; height: 0.47222in;" /></a></p>
<p>Once committed you’ll notice the rule now becomes active and the
previous commit warning is removed.</p>
<p><a class="reference internal" href="../_images/image18.png"><img alt="image17" src="../_images/image18.png" style="width: 6.5in; height: 1in;" /></a></p>
</div>
<div class="section" id="add-the-rule-list-to-a-route-domain">
<h2>4.5.6. Add the Rule List to a Route Domain<a class="headerlink" href="#add-the-rule-list-to-a-route-domain" title="Permalink to this headline">¶</a></h2>
<p>In this section, you are going to attach the rule to a route domain
using the <strong>Security</strong> selection in the top bar within the <strong>Route
Domain</strong> GUI interface.</p>
<p>Go to <strong>Network</strong>, then click on <strong>Route Domains</strong>, then select the
hyperlink for route domain <strong>0</strong>.</p>
<p>Now click on the <strong>Security</strong> top bar selection, which is a new option
that was added in version 11.3.</p>
<p>In the Network Firewall section, set the Enforcement: to <strong>“Enabled…”.</strong></p>
<p>Select the Policy you just created, “<strong>rd_0_policy</strong>” and click
Update.</p>
<p><a class="reference internal" href="../_images/image19.png"><img alt="image18" src="../_images/image19.png" style="width: 6.5in; height: 1.25in;" /></a></p>
<p>Review the rules that are now applied to this route domain by navigating
to:</p>
<p><strong>Security &gt; Network Firewall &gt; Active Rules.</strong></p>
<p>From the <strong>Context Filter</strong> select <strong>Route Domain 0</strong>. You can expand
the web_rule_list by clicking the plus sign, your screen should look
similar to the below screen shot.</p>
<p><a class="reference internal" href="../_images/image20.png"><img alt="image19" src="../_images/image20.png" style="width: 6.49514in; height: 1.37014in;" /></a></p>
</div>
<div class="section" id="test-the-new-firewall-rules">
<h2>4.5.7. Test the New Firewall Rules<a class="headerlink" href="#test-the-new-firewall-rules" title="Permalink to this headline">¶</a></h2>
<p>Once again you will generate traffic through the BIG-IP AFM and then
view the AFM (firewall) logs.</p>
<ul class="simple">
<li>Ping 10.30.0.50</li>
<li>Open a new Web browser and access <a class="reference external" href="http://10.30.0.50">http://10.30.0.50</a></li>
<li>Open a new Web browser and access <a class="reference external" href="http://10.30.0.50:8081">http://10.30.0.50:8081</a></li>
<li>SSH to 10.30.0.50 using Web Server shortcut (PUTTY) on desktop.</li>
</ul>
<p>In the Configuration Utility, open the <strong>Security &gt; Event Logs &gt; Network
&gt; Firewall</strong> page.</p>
<p>Access for port 80 was granted to a host using the web_rule_list:
<strong>allow_http</strong> rule.</p>
<p><a class="reference internal" href="../_images/image21.png"><img alt="image20" src="../_images/image21.png" style="width: 6.49097in; height: 0.70347in;" /></a></p>
<p>Requests for port 8081, and 22 were all rejected due to the
reject_10_20_0_0 rule.</p>
<p><a class="reference internal" href="../_images/image22.png"><img alt="image21" src="../_images/image22.png" style="width: 6.48125in; height: 0.60208in;" /></a></p>
<p>You may verify this, by going to <strong>Security &gt; Network Firewall &gt; Active
Rules</strong>, then selecting the context for route domain 0. Note the
<strong>Count</strong> field next to each rule as seen below. Also note how each rule
will also provide a <strong>Latest Matched</strong> field so you will know the last
time each rule was matched:</p>
<p><a class="reference internal" href="../_images/image23.png"><img alt="image22" src="../_images/image23.png" style="width: 6.49097in; height: 1.76875in;" /></a></p>
<p>Congratulations! Day one and you’ve already saved the day. Hang on,
something isn’t right, the images Mr. Lumbergh talked about are not
populating, they look like broken links.</p>
<p><a class="reference internal" href="../_images/image24.png"><img alt="image23" src="../_images/image24.png" style="width: 2.67327in; height: 2.26704in;" /></a></p>
<p>Let’s refresh the web page once more and see what the logs show….</p>
<p><a class="reference internal" href="../_images/image25.png"><img alt="image24" src="../_images/image25.png" style="width: 6.5in; height: 1.25903in;" /></a></p>
<p>If we follow the flow we can see the traffic to 10.30.0.50 is permitted
on port 80 however; there appears to be a second connection attempting
to open to another server, 10.40.0.50, also on port 80 (glad we put in
that reject rule and are logging all the traffic flows). Let’s look at
how this web page is written. To view the page source details, simply
<strong>right</strong> click anywhere on the <strong>10.30.0.50</strong> web page and select “view
page source”</p>
<p><a class="reference internal" href="../_images/image26.png"><img alt="image25" src="../_images/image26.png" style="width: 6.5in; height: 1.22222in;" /></a></p>
<p>Very interesting, it appears there are two images and they are links to
another server which appear to be a server on the application network,
which is also a link off of the firewall. You can verify this by looking
at the network settings on the BIG-IP found under: <strong>Network &gt; VLANs
and/or Network &gt; Self IPs.</strong> To resolve, let’s create another rule list
for this network as well to keep the rule lists separated for security
reasons.</p>
</div>
<div class="section" id="creating-an-additional-rule-list-for-additional-services">
<h2>4.5.8. Creating an Additional Rule List for Additional Services<a class="headerlink" href="#creating-an-additional-rule-list-for-additional-services" title="Permalink to this headline">¶</a></h2>
<p>Rules and Rule Lists can also be created and attached to a context from
the Active Rules section of the GUI. Go to the</p>
<p><strong>Security &gt; Network Firewall &gt; Rule Lists</strong></p>
<p>Create a <strong>Rule List</strong> called <strong>application_rule_list</strong> then click
<strong>Finished</strong>.</p>
<p>Enter the rule list by clicking on its hyperlink, then in the <strong>Rules</strong>
section click <strong>Add</strong>, and add the following information, then click
<strong>Finished</strong>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Name</strong></th>
<th class="head">allow_http</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>Protocol</strong></td>
<td>TCP</td>
</tr>
<tr class="row-odd"><td><strong>Source</strong></td>
<td>Leave at Default of <strong>Any</strong></td>
</tr>
<tr class="row-even"><td><strong>Destination Address</strong></td>
<td><strong>Specify…</strong>10.40.0.50, then click <strong>Add</strong></td>
</tr>
<tr class="row-odd"><td><strong>Destination Port</strong></td>
<td><strong>Specify…</strong>Port <strong>80</strong>, then click <strong>Add</strong></td>
</tr>
<tr class="row-even"><td><strong>Action</strong></td>
<td><strong>Accept-Decisively</strong></td>
</tr>
<tr class="row-odd"><td><strong>Logging</strong></td>
<td>Enabled</td>
</tr>
</tbody>
</table>
<p><a class="reference internal" href="../_images/image27.png"><img alt="image26" src="../_images/image27.png" style="width: 6.49097in; height: 0.75in;" /></a></p>
</div>
<div class="section" id="add-another-rule-list-to-the-policy">
<h2>4.5.9. Add Another Rule List to the Policy<a class="headerlink" href="#add-another-rule-list-to-the-policy" title="Permalink to this headline">¶</a></h2>
<p>Use the <strong>Policies</strong> page to add the new firewall rule list to the
<strong>rd_0_policy</strong>.</p>
<p>Open the <strong>Security &gt; Network Firewall &gt; Policies</strong> page.</p>
<p>Click on the policy name to modify the policy.</p>
<p>The only current active rule list is for the <strong>web_policy</strong>. Click on
the arrow next to <strong>Add Rule List, then select, Add the rule list AT
END)</strong> to add the new rule list you just created. For <strong>Name</strong> begin
typing ‘application_rule_list’, select /Common/application_rule_list,
then click <strong>Done Editing</strong>.</p>
<p>Remember to Commit the changes to system before proceeding.</p>
<p>Once completed, you should see a policy similar to the one below:</p>
<p><a class="reference internal" href="../_images/image28.png"><img alt="image27" src="../_images/image28.png" style="width: 6.5in; height: 1.66667in;" /></a></p>
</div>
<div class="section" id="test-access-to-the-server">
<h2>4.5.10. Test Access to the Server<a class="headerlink" href="#test-access-to-the-server" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Open a new Web browser and access <a class="reference external" href="http://10.30.0.50">http://10.30.0.50</a></li>
</ul>
<p>Good to, wait, <strong>not go</strong>. What happened? I added a rule, why didn’t this
work?</p>
<p>Let’s look at the logs again (<strong>Security &gt; Event Logs &gt; Network &gt;
Firewall).</strong> They basically look the same as before, lets look at the
ordering of the rule we just created (<strong>Security &gt; Network Firewall &gt;
Active Rules change contex to route domain 0).</strong> Take note the newly
created rule has a counter value of 0, if we look at the order we can
see the reject rule, which we added in the web_rule_list has incremented
and appears to be matching the traffic before it reaches our new rule.
<strong>(Be sure to expand the Rule List to see the counts)</strong> Let’s modify the
rule order slightly to accomplish what we’re looking for. From within
the Active Rules section simply drag the application_rule_list <strong>ABOVE</strong>
the web_rule_list. Don’t forget to commit the changes.</p>
<p>The new ordering should look something like the screen shot below:</p>
<p><a class="reference internal" href="../_images/image29.png"><img alt="image28" src="../_images/image29.png" style="width: 6.5in; height: 1.02778in;" /></a></p>
</div>
<div class="section" id="test-access-to-the-server-1">
<span id="id1"></span><h2>4.5.11. Test Access to the Server<a class="headerlink" href="#test-access-to-the-server-1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Open a new Web browser and access <a class="reference external" href="http://10.30.0.50">http://10.30.0.50</a></li>
</ul>
<p><strong>Success!!</strong></p>
<p>Before we continue let’s clean up the rules just a little for best
practices. The clean-up/catch-all/drop/etc rule is typically applied to
the end of your policy, not necessarily within the rule-list. While its
perfectly acceptable to have drop statements within individual rules to
prevent certain traffic, the broader drop statement should be applied at
the end of the policy (remember how AFM processes contexts from the
beginning of this lab – see pages 6+7).</p>
<p>Use the <strong>Rule Lists</strong> page to modify the firewall rule
<strong>‘web_rule_list’</strong>. Open the <strong>Security &gt; Network Firewall &gt; Rule
Lists</strong> page. Click on the rule list <strong>‘web_rule_list’</strong> to modify the
rule list. Check the box next to the reject_10_20_0_0 rule and click
‘<strong>Remove’.</strong> The updated rule should look something like the below
screen shot:</p>
<p><a class="reference internal" href="../_images/image30.png"><img alt="image29" src="../_images/image30.png" style="width: 6.49097in; height: 1.01875in;" /></a></p>
<p>Next, you’ll want to add the reject rule to the policy. In the
Configuration Utility, open the <strong>Security &gt; Network Firewall &gt;
Policies</strong> page. Click on the <strong>rd_0_policy</strong>. Select ‘Add Rule’ drop
down and select at the end. You’ll notice all the same options are
available within a policy as they are within a rule-list. Create an
entry with the following information then click Done Editing and commit
the change.</p>
<table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Name</strong></th>
<th class="head">reject_10_20_0_0</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>Protocol</strong></td>
<td>Any</td>
</tr>
<tr class="row-odd"><td><strong>Source</strong></td>
<td>Address 10.20.0.0/24, then click <strong>Add</strong></td>
</tr>
<tr class="row-even"><td><strong>Destination Address</strong></td>
<td>Any</td>
</tr>
<tr class="row-odd"><td><strong>Destination Port</strong></td>
<td>Any</td>
</tr>
<tr class="row-even"><td><strong>Action</strong></td>
<td>Reject</td>
</tr>
<tr class="row-odd"><td><strong>Logging</strong></td>
<td>Enabled</td>
</tr>
</tbody>
</table>
<p>The new Policy should look something like the screen shot below:</p>
<p><a class="reference internal" href="../_images/image31.png"><img alt="image30" src="../_images/image31.png" style="width: 6.5in; height: 1.14792in;" /></a></p>
</div>
<div class="section" id="id2">
<h2>4.5.12. Test the New Firewall Rules<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Once again you will generate traffic through the BIG-IP AFM and then
view the AFM (firewall) logs.</p>
<ul class="simple">
<li>Ping 10.30.0.50</li>
<li>Open a new Web browser and access <a class="reference external" href="http://10.30.0.50">http://10.30.0.50</a></li>
<li>Open a new Web browser and access <a class="reference external" href="http://10.30.0.50:8081">http://10.30.0.50:8081</a></li>
<li>SSH to 10.30.0.50 using Web Server shortcut on desktop</li>
</ul>
<p>In the Configuration Utility, open the <strong>Security &gt; Event Logs &gt; Network
&gt; Firewall</strong> page.</p>
<p>Access for port 80 on 10.30.0.50 was granted using the web_rule_list:
<strong>allow_http</strong> rule.</p>
<p><a class="reference internal" href="../_images/image32.png"><img alt="image31" src="../_images/image32.png" style="width: 6.5in; height: 0.5in;" /></a></p>
<p>Access for port 80 on 10.40.0.50 was granted using the
application_rule_list: <strong>allow_http</strong> rule.<a class="reference internal" href="../_images/image32.png"><img alt="image32" src="../_images/image32.png" style="width: 6.5in; height: 0.5in;" /></a></p>
<p>Ping to 10.30.0.50 was granted using the global rule.</p>
<p><a class="reference internal" href="../_images/image33.png"><img alt="image33" src="../_images/image33.png" style="width: 6.5in;" /></a></p>
<p>All other traffic was rejected by the rd_0_policy reject_10_20_0_0
reject rule</p>
<p><a class="reference internal" href="../_images/image34.png"><img alt="image34" src="../_images/image34.png" style="width: 6.49097in; height: 0.59236in;" /></a></p>
</div>
<div class="section" id="view-firewall-reports">
<h2>4.5.13. View Firewall Reports<a class="headerlink" href="#view-firewall-reports" title="Permalink to this headline">¶</a></h2>
<p>View several of the built-in network firewall reports and graphs on the
BIG-IP system. Open the <strong>Security &gt;Reporting &gt; Network &gt; Enforced
Rules</strong> page. The default report shows all the rule contexts that were
matched in the past hour.</p>
<p><a class="reference internal" href="../_images/image35.png"><img alt="image35" src="../_images/image35.png" style="width: 6.49097in; height: 2.49097in;" /></a></p>
<p>The default view gives reports per Context, in the drop-down menu select
<strong>Rules (Enforced)</strong>.</p>
<p><a class="reference internal" href="../_images/image36.png"><img alt="image36" src="../_images/image36.png" style="width: 6.5in; height: 2.5in;" /></a></p>
<p>From the <strong>View By</strong> list, select <strong>Destination Ports (Enforced)</strong>.</p>
<p><a class="reference internal" href="../_images/image37.png"><img alt="image37" src="../_images/image37.png" style="width: 2.64727in; height: 1.53731in;" /></a></p>
<p>This redraws the graph to report more detail for all the destination
ports that matched an ACL.</p>
<p><a class="reference internal" href="../_images/image38.png"><img alt="image38" src="../_images/image38.png" style="width: 6.5in; height: 2.66667in;" /></a></p>
<p>From the <strong>View By</strong> list, select <strong>Source IP Addresses (Enforced)</strong>.
This shows how source IP addresses matched an ACL clause:</p>
<p><a class="reference internal" href="../_images/image39.png"><img alt="image39" src="../_images/image39.png" style="width: 6.5in; height: 2.08333in;" /></a></p>
</div>
</div>



    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="step3.html" title="4.4. Advanced Firewall Manager (AFM)" accesskey="p" class="btn btn-primary pull-left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="step5.html" title="4.6. AFM Reference Material" accesskey="n" class="btn btn-primary pull-right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="../_static/js/bootstrap.min.js"></script>
  <script type="text/javascript">
    jQuery.noConflict(true)
  </script>
  <script src="../_static/js/clouddocs.js"></script>
  </body>
</html>